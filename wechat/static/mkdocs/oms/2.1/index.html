<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Zhaibibei">
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>1.执行Oracle命令界面建立 - 打造属于自己的监控系统-Django|Python|Oracle</title>

        <link href="../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-107412137-1', 'zhaibibei.cn');
            ga('send', 'pageview');
        </script>
        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">打造属于自己的监控系统-Django|Python|Oracle</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">首页</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Django创建网站 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../1.1/">1.Django框架介绍</a>
                        </li>
                    
                        <li >
                            <a href="../1.2/">2.数据库,模块等环境的准备</a>
                        </li>
                    
                        <li >
                            <a href="../1.3/">3.使用Django创建网站</a>
                        </li>
                    
                        <li >
                            <a href="../1.4/">4.使用Django管理数据库表</a>
                        </li>
                    
                        <li >
                            <a href="../1.5/">5.开始我们的第一个网页</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Django执行Oracle命令 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li class="active">
                            <a href="./">1.执行Oracle命令界面建立</a>
                        </li>
                    
                        <li >
                            <a href="../2.2/">2.获取Oracle数据文件创建的时间</a>
                        </li>
                    
                        <li >
                            <a href="../2.3/">3.获取Oracle表的分析时间</a>
                        </li>
                    
                        <li >
                            <a href="../2.4/">4.获取Oracle数据库段的大小</a>
                        </li>
                    
                        <li >
                            <a href="../2.5/">5.通过进程号获取SQL语句</a>
                        </li>
                    
                        <li >
                            <a href="../2.6/">6.通过会话查看进程号</a>
                        </li>
                    
                        <li >
                            <a href="../2.7/">7.获取Oracle临时表空间的使用率</a>
                        </li>
                    
                        <li >
                            <a href="../2.8/">8.获取Oracle执行次数等于一的语句(硬解析状况)</a>
                        </li>
                    
                        <li >
                            <a href="../2.9/">9.检查未绑定变量的语句(硬解析状况)</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Django自定义命令 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../3.1/">1.让Django运行自定义命令</a>
                        </li>
                    
                        <li >
                            <a href="../3.2/">2.使用自定义命令获取Oracle监控指标</a>
                        </li>
                    
                        <li >
                            <a href="../3.3/">3.将Oracle监控指标在前端展现</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../1.5/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../2.2/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#oracle">执行Oracle命令界面的建立</a></li>
        
            <li><a href="#_1">一些其他文件支持</a></li>
        
            <li><a href="#urlspy">urls.py页面</a></li>
        
            <li><a href="#viewspy">views.py</a></li>
        
            <li><a href="#template">template文件</a></li>
        
            <li><a href="#_2">最终效果</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="oracle">执行Oracle命令界面的建立</h1>
<p>听过前面几期的介绍，我们从如何安装django到连接数据库并建立第一个页面</p>
<p>接下来的专题讲述如何将日常运维需要的命令放到我们的监控系统中</p>
<p>即利用Django执行Oracle命令并将结果在网站上显示</p>
<p><strong>开发环境</strong></p>
<p>操作系统:CentOS 7.3 </p>
<p>Python版本 :2.7 </p>
<p>Django版本: 1.10.5 </p>
<p>操作系统用户:oracle</p>
<h2 id="_1">一些其他文件支持</h2>
<p><strong>jquery文件</strong></p>
<p>接下来我们还需要jquery的一些模块,需要将js文件放到static目录下</p>
<p><strong>dashboard.css文件</strong></p>
<p>在后面的模板文件中我们需要用到dashboard.css文件，这里先把它放到static/css目录下</p>
<p><strong>建立页面的步骤</strong></p>
<p>我们还是通过这张图的步骤来说明如何建立页面</p>
<p><img alt="Alt text" src="../image/1/3.png" /></p>
<h2 id="urlspy">urls.py页面</h2>
<p>首先编辑 monitor/urls.py</p>
<pre><code>urlpatterns = [
   url(r'^$', views.index, name='index'),
   url(r'^oracle_command/$',views.oracle_command, name='oracle_command'),
]
</code></pre>

<p>oracle_command为执行Oracle命令的页面</p>
<h2 id="viewspy">views.py</h2>
<p>下面为oracle_command 对应的函数在views.py里面的写法</p>
<pre><code>def oracle_command(request):
   result=oraclelist.objects.all().order_by('tnsname')
   dic={'result':result}
   return render_to_response('oracle_command.html',dic)

</code></pre>

<ol>
<li>该函数首先将oraclelist 表中的所有数据取出来(按tnsname排序)，并把它们放到result变量中 </li>
<li>然后再将result 和’result’绑定并赋值给dic </li>
<li>最后将dic传入到template模板文件中</li>
</ol>
<h2 id="template">template文件</h2>
<p>Django模板系统可以使我们继承其他的模板内容，这样可以简化我们模板文件的内容</p>
<p><strong>首先我们建立base.html 页面作为基础模板</strong></p>
<pre><code> &lt;nav class=&quot;navbar navbar-inverse navbar-fixed-top&quot; role=&quot;navigation&quot;&gt;
      &lt;div class=&quot;container-fluid&quot;&gt;
        &lt;div class=&quot;navbar-header&quot;&gt;
          &lt;button type=&quot;button&quot; class=&quot;navbar-toggle collapsed&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#navbar&quot; aria-expanded=&quot;false&quot; aria-controls=&quot;navbar&quot;&gt;
            &lt;span class=&quot;sr-only&quot;&gt;Toggle navigation&lt;/span&gt;
            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
          &lt;/button&gt;
          &lt;a class=&quot;navbar-brand&quot; href=&quot;#&quot;&gt;Oracle监控系统&lt;/a&gt;
        &lt;/div&gt;
        &lt;div id=&quot;navbar&quot; class=&quot;navbar-collapse collapse&quot;&gt;
          &lt;ul class=&quot;nav navbar-nav navbar-right&quot;&gt;
            &lt;li&gt;&lt;a href=&quot;#&quot;&gt;Dashboard&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a _blank_=True href=&quot;/admin&quot;&gt;Settings&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;#&quot;&gt;Profile&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;#&quot;&gt;Help&lt;/a&gt;&lt;/li&gt;
          &lt;/ul&gt;
          &lt;form class=&quot;navbar-form navbar-right&quot;&gt;
            &lt;input type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;Search...&quot;&gt;
          &lt;/form&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/nav&gt;

    &lt;div class=&quot;container-fluid&quot;&gt;
      &lt;div class=&quot;row&quot;&gt;
        &lt;div class=&quot;col-sm-3 col-md-2 sidebar&quot;&gt;
          &lt;ul class=&quot;nav nav-sidebar&quot;&gt;
           {% block overview %} &lt;li&gt; &lt;a href=&quot;/monitor/&quot;&gt;首页&lt;/a&gt;&lt;/li&gt;{%endblock%}
           {% block admin %} &lt;li&gt; &lt;a target=_blank href=&quot;/admin&quot;&gt;后台&lt;/a&gt;&lt;/li&gt;{%endblock%}
           {% block dbstatus%}&lt;li&gt;&lt;a href=&quot;/monitor/oracle_status&quot;&gt;数据库状态&lt;/a&gt;&lt;/li&gt;{%endblock%}
           {% block command %} &lt;li&gt; &lt;a href=&quot;/monitor/oracle_command&quot;&gt;Oracle命令&lt;/a&gt;&lt;/li&gt; {%endblock%}
          &lt;/ul&gt;
          &lt;ul class=&quot;nav nav-sidebar&quot;&gt;
            &lt;li&gt;&lt;a href=&quot;&quot;&gt;数据库等待事件&lt;/a&gt;&lt;/li&gt;
            {%block day%}&lt;li&gt;&lt;a href=&quot;/monitor/oracle_performance/&quot;&gt;数据库性能(天/周)&lt;/a&gt;&lt;/li&gt; {%endblock%}
            &lt;li&gt;&lt;a href=&quot;&quot;&gt;数据库性能(时)&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;&quot;&gt;数据库TOPSQL&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;&quot;&gt;数据库命中率&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;&quot;&gt;数据库性能基线&lt;/a&gt;&lt;/li&gt;
          &lt;/ul&gt;
          &lt;ul class=&quot;nav nav-sidebar&quot;&gt;
            &lt;li&gt;&lt;a href=&quot;&quot;&gt;服务器空间&lt;/a&gt;&lt;/li&gt;
           {%block cpu %} &lt;li&gt;&lt;a href=&quot;&quot;&gt;服务器CPU内存&lt;/a&gt;&lt;/li&gt; {%endblock%}
          &lt;/ul&gt;
        &lt;/div&gt;

{%block content %} Content{% endblock %}
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>这里我们截取一部分</p>
<p>{% block overview %} {%endblock%} </p>
<p>表示的是在后面继承的时候可替换的部分，后面有例子介绍</p>
<p>这个页面目前只有Oracle命令这块有写代码，其他的后面会介绍。</p>
<p><strong>接下来我们修改上节讲的index 页面，让它也继承base.html文件</strong></p>
<p>具体见源码</p>
<p><strong>然后是oracle_command界面</strong></p>
<pre><code>{% extends &quot;base.html&quot; %}

{% block jscript%}
&lt;script&gt;
$(function() {
    var a= $('#operate');
    var b= $('#sqlarea');
    var options= $('#operate option');
    a.on('change',function() {
        var result=$('#operate option').filter(':selected').val();
        names=['check_analyzed_time','check_process_text' ,'check_session_process' ,'check_sqlplan' ,'check_unboundsql']
        //alert(result)
        if ($.inArray(result,names)&gt;-1){
            b.show();
      } else
            b.hide();
       });

})

&lt;/script&gt;
</code></pre>

<p>{% extends “base.html” %} 表示的是继承base.html模板</p>
<p>后面是javascript脚本</p>
<p>接下来是个表单(form)</p>
<pre><code>{% block content %}


&lt;div class=&quot;col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main&quot; id='content'&gt;
    &lt;h1 class='page-header'&gt;Oracle命令&lt;/h1&gt;
&lt;form  id='usubmit'action=&quot;/monitor/commandresult/&quot; method=&quot;get&quot;&gt;
&lt;div class=&quot;form-group&quot;&gt;
    &lt;label for=&quot;ipaddress&quot;&gt;请选择数据库&lt;/label&gt;
    &lt;select class=&quot;form-control&quot;  id=&quot;ipaddress&quot; name=&quot;ipaddress&quot;&gt;
  {% for x in result %}
      &lt;option value =&quot;{{ x.ipaddress}}-{{x.tnsname}}&quot;&gt;{{ x.tnsname }} {{x.ipaddress}}&lt;/option&gt;
  {% endfor %}
     &lt;/select&gt;
&lt;/div&gt;
&lt;div class=&quot;form-group&quot;&gt;
    &lt;label for=&quot;operate&quot;&gt;请选择命令&lt;/label&gt;
  &lt;select  class=&quot;form-control&quot; id=&quot;operate&quot;  name=&quot;operate&quot;&gt;
      &lt;option value ='check_datafile_time' selected=&quot;selected&quot;&gt;检查数据文件创建时间&lt;/option&gt;
      &lt;option value ='check_analyzed_time'&gt;检查表的分析时间&lt;/option&gt;
      &lt;option value ='check_segments_size'&gt;查看数据库段的大小&lt;/option&gt;
      &lt;option value ='check_process_text'&gt;查看进程对应的SQL语句&lt;/option&gt;
      &lt;option value ='check_session_process'&gt;查看会话对应的进程号&lt;/option&gt;
      &lt;option value ='check_temp_usage'&gt;检查临时表空间使用率&lt;/option&gt;
      &lt;option value ='check_executions'&gt;检查执行次数等于一的语句&lt;/option&gt;
      &lt;option value ='check_unboundsql'&gt;检查未绑定语句&lt;/option&gt;
      &lt;option value ='check_session_count'&gt;检查Session数量&lt;/option&gt;
     &lt;/select&gt;
&lt;/div&gt;

&lt;div id='sqlarea'  class=&quot;form-group&quot; hidden&gt;
    &lt;label for=&quot;sql22&quot;&gt;请输入相关文本&lt;/label&gt;
    &lt;textarea class=&quot;form-control&quot; name='sql' id='sql1' rows=1 &gt;&lt;/textarea&gt;
&lt;/div&gt;

&lt;button type=&quot;submit&quot;  class=&quot;btn btn-primary&quot; value=&quot;OK&quot;&gt;确定&lt;/button&gt;
&lt;/form&gt;

&lt;/div&gt;



{% endblock %}
</code></pre>

<p>该表单分为三个部分 </p>
<ol>
<li>
<p>请选择数据库:这里循环获取oraclelist表中到的数据然后将其放到下拉菜单中 </p>
</li>
<li>
<p>请选择命令:这里我们将日常需要用到的一些命令放到下拉菜单中 </p>
</li>
<li>
<p>请输入相关文:这里需要输入一些上面命令需要用到参数，在一些不需要的命令中是隐藏的，通过上面的js脚本控制，大家一看就明白了</p>
</li>
</ol>
<h2 id="_2">最终效果</h2>
<p>http://10.65.202.218:8081/monitor/oracle_command/</p>
<p><img alt="Alt text" src="../image/2/9.png" /></p>
<p><img alt="Alt text" src="../image/2/10.png" /></p>
<p><img alt="Alt text" src="../image/2/11.png" /></p>
<p><strong>源码地址</strong></p>
<p>源码请查看我的GitHub主页</p>
<p><a href="https://github.com/bsbforever/wechat_monitor">https://github.com/bsbforever/wechat_monitor</a></p>
<p>下期将介绍如何执行命令并将结果显示在页面中</p></div>
        </div>

	<footer class="col-md-12">
		<hr>
		
		<p>苏ICP备17053688号</p>
		
		<p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
	</footer>


        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
    </body>
</html>